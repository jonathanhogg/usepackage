##############################################################################
# 
# Copyright (C) 2001 Jonathan Hogg
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
# 
# Name   : Makefile
# Author : Jonathan Hogg <jonathan@dcs.gla.ac.uk>
# 
##############################################################################


### Makefile ###

#--- edit these variables to customise (or supply them as make args) ---#


# Installation root:

prefix = @prefix@
exec_prefix = @exec_prefix@

BINDIR = ${exec_prefix}/bin
LIBDIR = ${exec_prefix}/lib
MANDIR = @mandir@

# List of package spec files to install:

PACKAGE_FILES = packages.master packages.vlsi packages.fp packages.rapids \
		packages.contrib packages.our

# Which package spec file to load first:

MASTER_PACKAGE_FILE = packages.master

# Path for finding package specs:

DEFAULT_PACKAGE_PATH = ${prefix}/lib/usepackage:~:.


#--- usual stuff about not editing below this line unless you're sure ---#


CC = @CC@
LINKCC = @CC@
CFLAGS = @CFLAGS@
LDFLAGS = @LDFLAGS@
DEFINES = -DDEFAULT_PACKAGE_PATH=\"$(DEFAULT_PACKAGE_PATH)\" \
	-DMASTER_PACKAGE_FILE=\"$(MASTER_PACKAGE_FILE)\"
M4 = @M4@
LEX = @LEX@
YACC = @YACC@ -d
MV = mv
RM = rm -f

INSTALL = @INSTALL@
INSTALL_EXEC = ${INSTALL} -m 555
INSTALL_FILE = ${INSTALL} -m 444
INSTALL_DIR = ${INSTALL} -m 755 -d


#--- and below this line only if you're *really* sure what you're doing ---#


all: README usepackage use.bsh use.csh use.ksh use.1

install: install-exec install-lib install-man

install-exec: usepackage
	$(INSTALL_DIR) ${BINDIR}
	$(INSTALL_EXEC) usepackage ${BINDIR}/usepackage

install-lib: README use.bsh use.csh use.ksh
	$(INSTALL_DIR) ${LIBDIR}/usepackage
	$(INSTALL_FILE) README ${LIBDIR}/usepackage/README
	$(INSTALL_EXEC) use.bsh ${LIBDIR}/usepackage/use.bsh
	$(INSTALL_EXEC) use.csh ${LIBDIR}/usepackage/use.csh
	$(INSTALL_EXEC) use.ksh ${LIBDIR}/usepackage/use.ksh
	for package in $(PACKAGE_FILES) ;\
	do \
	    $(INSTALL_FILE) $$package ${LIBDIR}/usepackage/$$package ;\
	done

install-man: use.1
	$(INSTALL_DIR) ${MANDIR}/man1
	$(INSTALL_FILE) use.1 ${MANDIR}/man1

OBJECTS = usepackage.o grammar.o scanner.o linked_list.o utils.o match.o

usepackage: $(OBJECTS)
	$(LINKCC) $(LDFLAGS) -o usepackage $(OBJECTS)

grammar.c grammar.h: grammar.y
	$(YACC) grammar.y
	$(MV) y.tab.c grammar.c
	$(MV) y.tab.h grammar.h

scanner.c: scanner.l
	$(LEX) scanner.l
	$(MV) lex.yy.c scanner.c

clean:
	$(RM) README usepackage use.bsh use.csh use.ksh use.1 \
		$(OBJECTS) scanner.c grammar.c grammar.h

distclean: clean
	$(RM) Makefile config.h config.cache config.log config.status

%.o: %.c
	$(CC) $(CFLAGS) $(DEFINES) -c $*.c

%: %.in
	$(M4) -DINSTALL_DIR=$(DEST) \
	      -DMASTER_PACKAGE_FILE=$(MASTER_PACKAGE_FILE) $*.in > $*


linked_list.o: linked_list.h
match.o: package.h linked_list.h
usepackage.o: package.h linked_list.h utils.h version.h
grammar.o: package.h linked_list.h utils.h
scanner.o: package.h grammar.h

